// Code generated by server-gen. DO NOT EDIT.
package {{.Service.ApiVersion}}

import (
	"context"
)

import (
{{- range .Imports}}
	{{if .Alias}}{{.Alias}} "{{.Path}}"{{else}}"{{.Path}}"{{end}}
{{- end}}
)

{{if .EnableMock}}//go:generate go run -mod=mod github.com/golang/mock/mockgen -source=$GOFILE -package=mock$GOPACKAGE -destination=mock/$GOFILE{{end}}
type runtime interface {
{{- range .Service.Calls}}
{{- if eq .MethodType 1}}
	Create(ctx context.Context, resource *{{.ResourceType}}) (*{{.ResourceType}}, error)
{{- else if eq .MethodType 2}}
	Get(ctx context.Context, name string) (*{{.ResourceType}}, error)
{{- else if eq .MethodType 3}}
	Delete(ctx context.Context, name string) (*{{.ResponseType}}, error)
{{- else if eq .MethodType 4}}
	List(ctx context.Context, pageSize int32, page *v1.Pagination) ([]*{{.ResourceType}}, *v1.Pagination, error)
{{- else if eq .MethodType 5}}
	Update(ctx context.Context, resource *{{.ResourceType}}, mask *fieldmaskpb.FieldMask) (*{{.ResourceType}}, error)
{{- end}}
{{- end}}
}

type service struct {
	{{.Service.UnimplementedServer}}
	logger *zap.Logger
	rt     runtime
}

func NewService(logger *zap.Logger, rt runtime) *service {
	return &service{
		logger: logger.Named("{{.Service.Name}}.{{.Service.ApiVersion}}"),
		rt:     rt,
	}
}

{{range .Service.Calls}}
func (s *service) {{.Name}}(ctx context.Context, req *{{.RequestType}}) (*{{.ResponseType}}, error) {
	logger := s.logger.With(zap.String("method", "{{.Name}}"), zap.Any("request", req))
	logger.Debug("request received")
{{- if eq .MethodType 1}}
	res, err := s.rt.Create(ctx, req.{{.GetResourceMethod}}())
{{- else if eq .MethodType 2}}
	res, err := s.rt.Get(ctx, req.GetName())
{{- else if eq .MethodType 3}}
	res, err := s.rt.Delete(ctx, req.GetName())
{{- else if eq .MethodType 4}}
	page, err := helper.Pagination(req)
	if err != nil {
		return helper.ErrorOr[{{.ResponseType}}](logger, nil, err)
	}
	resources, page, err := s.rt.List(ctx, req.GetPageSize(), page)
	if err != nil {
		return helper.ErrorOr[{{.ResponseType}}](logger, nil, err)
	}
	token, err := helper.PageToken(page)
	if err != nil {
		return helper.ErrorOr[{{.ResponseType}}](logger, nil, err)
	}
	res := &{{.ResponseType}}{
		{{.ListField}}: resources,
		NextPageToken: token,
	}
{{- else if eq .MethodType 5}}
	res, err := s.rt.Update(ctx, req.{{.GetResourceMethod}}(), req.GetUpdateMask())
{{- end}}
	return helper.ErrorOr(logger, res, err)
}

{{end}}
